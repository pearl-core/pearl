# vim: ft=yaml

language: python

addons:
  apt:
    packages:
    - zsh
    - fish
  homebrew:
    packages:
    - zsh
    - fish
    - shellcheck

jobs:
  include:
    - name: "Run integ tests with Python 3.7 on Linux"
      os: linux
      python: "3.7"
    - name: "Run integ tests with Python 3.10 on Linux"
      os: linux
      python: "3.10"
    - name: "Run integ tests on MacOS"
      os: osx
      osx_image: xcode12
      # https://docs.travis-ci.com/user/languages/python/#running-python-tests-on-multiple-operating-systems
      language: shell       # 'language: python' is an error on Travis CI macOS


before_install:
  - python --version
  - /usr/bin/env python --version
  - /usr/bin/env python3 --version
  - git --version
  - bash --version
  - /usr/bin/env bash --version
  - zsh --version
  - fish --version
  # https://python-poetry.org/docs/#installation
  - curl -sSL https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py | /usr/bin/env python3 -
  - export PATH="$HOME/.poetry/bin:$PATH"

script:
  - make default-ci


after_success:
  - |
    if [[ "$TRAVIS_PYTHON_VERSION" == "3.7" && "$TRAVIS_OS_NAME" == "linux" ]]; then
      if [[ "$TRAVIS_BRANCH" != "master" ]]; then
        PYPI_PASSWORD="${PYPI_TEST_PASSWORD}" make publish-test
      fi;
      if [[ "$TRAVIS_BRANCH" == "master" ]]; then
        PYPI_PASSWORD="${PYPI_PROD_PASSWORD}" make publish;
      fi;
    fi;
